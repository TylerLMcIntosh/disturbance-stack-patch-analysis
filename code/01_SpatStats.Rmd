Run basic spatial statistics on disturbance stack

Tyler L. McIntosh
CU Boulder CIRES Earth Lab
Last updated: 10/20/23

This script uses the following naming conventions wherever possible:
 lowerCamelCase for variables
 period.separated for functions
 underscore_separated for files

# Setup

```{r, echo = FALSE, warning = FALSE}
# SETUP ----
## Libraries ----

#Check the required libraries and download if needed
list.of.packages <- c("tidyverse", #Includes ggplot2, dplyr, tidyr, readr, purrr, tibble, stringr, forcats
                      "terra", #New raster data package, documentation pdf here: https://cran.r-project.org/web/packages/terra/terra.pdf
                      "future", "future.apply", "furrr", "doFuture", "progressr", #Futureverse! https://www.futureverse.org/packages-overview.html; https://henrikbengtsson.github.io/course-stanford-futureverse-2023/
                      "sf", #New vector data package
                      "mapview", #For quick interactive mapping
                      "here", #Relative path best practices
                      "landscapemetrics",  #Fragstats for R
                      "tictoc", #time running of processes
                      "tmap",
                      "glue", #easy strings
                      "remotes", #to access github libraries
                      "ggpmisc") #For adding R^2 to plots

#Install all packages that aren't installed yet
install.packages(setdiff(list.of.packages, rownames(installed.packages())))

#Load all packages
invisible(lapply(list.of.packages, library, character.only = TRUE)) #use 'invisible' to prevent output being displayed

#Install ecoregions package from github if needed, then load package
if(!"ecoregions" %in% rownames(installed.packages())) {
  remotes::install_github("tomroh/ecoregions")
}
library(ecoregions)


## Clean workspace & set up environment ----
rm(list=ls()) #Ensure empty workspace if running from beginning
here::here() #Check here location
here::i_am("code/01_SpatStats.Rmd")
#OR
#setwd() #Set working directory directly
options(digits = 6) #Set standard decimal print output
options(scipen = 999) #Turn scientific notation on and off (0 = on, 999 = off)
```

# Manage computing & CI vs local

```{r}
#Start futureverse parallel computing
plan(multisession)

#Local, or on CyVerse (data storage different...)



```


# Load data and manage data paths

```{r, echo = FALSE}
#Load data
fileLocation <- here::here('data', 'nathan_outputs')

fireInsects <- terra::rast(here::here(fileLocation, "fire_and_insects.tif"))
fireStack <- terra::rast(here::here(fileLocation, "fire_stack.tif"))

#Load EPA ecoregion data from ecoregions package
epaL3 <- ecoregions::ContinentalUsEcoregion3 %>% 
  sf::st_transform(crs(fireInsects))
epaL4 <- ecoregions::ContinentalUsEcoregion4 %>% 
  sf::st_transform(crs(fireInsects))

  
#EPA ecoregion distinct name table for joins
nameJoin <- cbind(epaL4$us_l4name, 
                  gsub(" ", "", epaL4$us_l4name),
                  epaL4$us_l3name,
                  gsub(" ", "", epaL4$us_l3name)) %>% 
  `colnames<-`(c('us_l4name', 'us_l4nameclean', 'us_l3name', 'us_l3nameclean')) %>%
  as.data.frame() %>%
  dplyr::distinct() %>%
  dplyr::mutate(us_l4l3name = glue::glue("{us_l4nameclean}{us_l3nameclean}"))

```

# Set the areas of interest

```{r}
aoiL3Interest <- epaL3 %>% filter(us_l3name == "Sierra Nevada" | 
                                us_l3name == "Middle Rockies" | 
                                us_l3name == "Idaho Batholith" | 
                                us_l3name == "Southern Rockies") %>%
  group_by(us_l3name) %>%
  summarize(geometry = st_union(geometry)) %>%
  mutate(us_l3nameclean = gsub(" ", "", us_l3name))


aoiL4Interest <- epaL4 %>%
  filter(us_l3name == "Sierra Nevada" | 
                                us_l3name == "Middle Rockies" | 
                                us_l3name == "Idaho Batholith" | 
                                us_l3name == "Southern Rockies") %>%
  group_by(us_l4name, us_l3name) %>%
  summarize(geometry = st_union(geometry)) %>%
  left_join(nameJoin, join_by(us_l3name, us_l4name))

```

# Create raster sets for AOIs

```{r}
#Function to clip a raster to a vector, ensuring in same projection
#Returns raster in original projection, but clipped and masked to vector
careful.clip <- function(raster, vector) {
  if (sf::st_crs(vector) != terra::crs(raster)) { #if raster and vector aren't in same projection, change vector to match
    print("Projecting vector")
    vector <- sf::st_transform(vector, terra::crs(raster)) 
  } else {
    print("Vector already in raster CRS")
  }
  print("Clipping")
  r <- terra::crop(raster,
                   vector,
                   mask = TRUE) #crop & mask
  return(r)
}

#Function to clip a raster to a set of polygons (one clip per polygon in set),
#ensuring they are in the same projection
#Namefield indicates the field to use to name the item in the returned list (e.g. us_l3name)
#Returns the set of rasters as a named list 
careful.clip.set <- function(raster, vectors, namefield) {
  out <- list()
  nms <- c()
  for(i in 1:nrow(vectors)) {
    vec <- vectors[i,]
    clipped <- careful.clip(raster, vec)
    nm <- dplyr::select(sf::st_drop_geometry(vec) %>% ungroup(), {{namefield}}) %>%
  as.character()
    out[[nm]] <- clipped
  }
  return(out)
}

#fireInsectInterestList <- careful.clip.set(fireInsects, aoiL4Interest, us_l4l3name)
fireInsectInterestList <- careful.clip.set(fireInsects, aoiL3Interest, us_l3nameclean)



```

